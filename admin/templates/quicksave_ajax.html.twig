<script>
    {# simply makes an ajax post with route and editor content #}
    document.addEventListener('DOMContentLoaded', function () {
        var form = $('#saveajax');
        form.submit(function (e) {
            // prevent form submission
            e.preventDefault();

            var content;
            // Try the default Grav editor
            var item = $('div.form-field:not(.frontmatter) .CodeMirror');
            if (item.length !== 0 && item.is(':visible')) {
                content = item[0].CodeMirror.getValue();
            }
            // Try the hidden field approach
            if (content === undefined) {
                item = $('#custom-editor-value');
                if (item.length !== 0) {
                    content = item.val();
                }
            }
            // Try another approach
            if (content === undefined) {
                item = $('#data\\[content\\]');
                if (item.length !== 0) {
                    content = item.val();
                }
            }
            if (content === undefined) {
                throw "Could not locate an editor content field";
            }

            // submit the form via Ajax
            $.ajax({
                url: '{{ base_url }}/save-content',
                type: 'post',
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                data: JSON.stringify({
                    route: "{{ context.rawRoute }}",
                    content
                }),
                success: function (result) {
                    healthy_snackbar(result.message);
                    {% if config.plugins.quicksave.clear_dirty %}
                    // clear the dirty state
                    const forms = Grav.default.Forms;
                    forms.FormState.Instance = new forms.FormState.FormState();
                    {% endif %}
                },
                error: function (result) {
                    healthy_snackbar("There was an unexpected error while saving the content.");
                }
            });
        });
    });
</script>
